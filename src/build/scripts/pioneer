#!/bin/bash

# Default to automatic threading if JULIA_NUM_THREADS is not set
if [ -z "$JULIA_NUM_THREADS" ]; then
    export JULIA_NUM_THREADS=auto
fi

ARGS=()
while [[ $# -gt 0 ]]; do
    case $1 in
        --threads)
            if [[ -n "$2" && "$2" != --* ]]; then
                export JULIA_NUM_THREADS="$2"
                shift 2
                continue
            else
                echo "Error: --threads requires a value" >&2
                exit 1
            fi
            ;;
        --threads=*)
            export JULIA_NUM_THREADS="${1#*=}"
            shift
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

SCRIPT_PATH="$0"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"

exec "$SCRIPT_DIR/bin/PioneerCLI" "${ARGS[@]}"
